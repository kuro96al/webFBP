<!DOCTYPE html>
<html>

<head>
	<link rel="stylesheet" href="library/css/joint.min.css" />
	<link rel="stylesheet" href="library/jquery-ui-1.12.1.custom/jquery-ui.css" />
	<script src="library/js/jquery.js"></script>
	<script src="library/js/lodash.js"></script>
	<script src="library/js/backbone.js"></script>
	<script src="library/js/joint.min.js"></script>
	<script src="library/js/bacon.js"></script>
	<script src="library/jquery-ui-1.12.1/jquery-ui.min.js"></script>
	<script src="library/ace/src-min-noconflict/ace.js"></script>
	<script src="library/ace/src-min-noconflict/mode-xml.js"></script>
	<style>
		#droppable {
			height: 500px;
			width: 1000px;
			padding: 0.5em;
			float: left;
			margin: 10px;
			background-color: #EDF7FF;
			display: flex;
		}
		
		.draggableComponent {
			width: 80px;
			height: 20px;
			padding: 0.5em;
			float: left;
			margin: 10px 30px 10px 0;
		}
		
		#accordion-resizer-component {
			padding: 10px;
			width: 300px;
			height: 600px;
			float: left;
			display: flex;
		}
		
		#accordion-resizer-option {
			padding: 10px;
			width: 700px;
			height: 600px;
			float: left;
			display: flex;
		}
		
		ul {
			list-style-type: none;
			margin: 0;
			padding: 0;
			margin-bottom: 10px;
		}
		
		.clearfix:after {
			display: block;
			clear: both;
			content: "";
		}
		
		#component-option {
			height: 500px;
			width: 500px;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
		}
		
		#editor {
			height: 500px;
			width: 500px;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
		}
	</style>

</head>

<body>
	<div id="tabs">
		<ul>
			<li><a href="#tabs-1">Flow Editor</a></li>
			<li><a href="#tabs-2">Test Place</a></li>
			<li><a href="#tabs-3">Component Creator</a></li>
		</ul>
		<div id="tabs-1">
			<div class="clearfix">
				<div id="accordion-resizer-component" class="ui-widget-content">
					<div class="accordion">
						<h3>Test Component</h3>
						<div>

							<ul id="sortable">
								<li id="up" class="ui-state-default draggableComponent" title="1秒ごとに1を出力する">up</li>
								<li id="down" class="ui-state-default draggableComponent" title="1秒ごとに-1を出力する">down</li>
								<li id="multi" class="ui-state-default draggableComponent" title="入力に対して2をかけて出力する">multi</li>
								<li id="display" class="ui-state-default draggableComponent" title="displayに表示されている数字に入力された値を足す">display</li>
							</ul>
						</div>
						<h3>Sensor Component</h3>
						<div>
						</div>
						<h3>Section 3</h3>
						<div>
						</div>
						<h3>Section 4</h3>
						<div>
						</div>
					</div>
				</div>
				<div id="droppable">
					<button id="deploy" class="ui-state-default"> Deploy </button>
					<div id="myholder" style="height:100%;width:100%; overflow-y: auto; overflow-x: auto;"></div>
				</div>
			</div>
		</div>
		<div id="tabs-2">
			<p>
				Test Component Display : <span id="counter">0</span>
			</p>
		</div>
		<div id="tabs-3">
			<div class="clearfix">
				<div id="accordion-resizer-option" class="ui-widget-content">
					<div class="accordion">
						<h3>Basic Settings</h3>
						<div>

							<label for="component-name">Component Name</label>
							<input type="text" id="component-name">

							<p>
								<div class="widget">
									<fieldset>
										<legend>Select a Component Type: </legend>
										<label for="in-out">IN&OUT</label>
										<input type="radio" name="inout-type" id="in-out">
										<label for="only-in">OnlyIN</label>
										<input type="radio" name="inout-type" id="only-in">
										<label for="only-out">OnlyOUT</label>
										<input type="radio" name="inout-type" id="only-out">
									</fieldset>
								</div>
							</p>

						</div>
						<h3>Advanced Settings</h3>
						<div>
						</div>
						<h3>Section 3</h3>
						<div>
						</div>
						<h3>Section 4</h3>
						<div>
						</div>
					</div>
				</div>
				<div style="float:left;">
					<fieldset>
						<legend>Component Editor</legend>
						<div id="editor"></div>
						<button id="create-component" class="ui-state-default"> Create Component </button>
					</fieldset>
				</div>
			</div>
		</div>
	</div>
	</div>



	<script type="text/javascript">

//queue
function Queue() {
	this.__a = new Array();
}

Queue.prototype.enqueue = function(o) {
	this.__a.push(o);
}

Queue.prototype.dequeue = function() {
	if( this.__a.length > 0 ) {
		return this.__a.shift();
	}
	return null;
}

Queue.prototype.size = function() {
	return this.__a.length;
} 

Queue.prototype.toString = function() {
	return '[' + this.__a.join(',') + ']';
}

//joinjs開始
    var graph = new joint.dia.Graph;

    var paper = new joint.dia.Paper({
        el: $('#myholder'),
 height: $('#myholder').height(),
 width: $('#myholder').width(),
        model: graph,
        gridSize: 1,
   defaultLink: new joint.dia.Link({
        attrs: { '.marker-target': { d: 'M 10 0 L 0 5 L 10 10 z' } }
    }),
    validateConnection: function(cellViewS, magnetS, cellViewT, magnetT, end, linkView) {
        // Prevent linking from input ports.
        if (magnetS && magnetS.getAttribute('type') === 'input') return false;
        // Prevent linking from output ports to input ports within one element.
        if (cellViewS === cellViewT) return false;
        // Prevent linking to input ports.
        return magnetT && magnetT.getAttribute('type') === 'input';
    },
    validateMagnet: function(cellView, magnet) {
        // Note that this is the default behaviour. Just showing it here for reference.
        // Disable linking interaction for magnets marked as passive (see below `.inPorts circle`).
        return magnet.getAttribute('magnet') !== 'passive';
    }
});

    //コンポーネントがinを持っているか判定


    //UUID生成
function generateUUID(length) {
  var s = "";
  length = length || 32;
  for (i = 0; i < length; i++) {
    random = Math.random() * 16 | 0;
    s += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
  }
  return s;
}
    //groupID+UUIDからgroupIDを抽出
    function getGroupID(id){
       var ID = id.split("/");
      return ID[0];
    }

    function createSourceFlow(){
      return Bacon.interval(1000,1);
    }

  
    //コンポーネントの定義

var stationeryComponent = new joint.shapes.devs.Model({
    position: { x: 50, y: 50 },
    size: { width: 90, height: 90 },
    inPorts: [],
    outPorts: [],
    attrs: {
        '.label': { text: 'stationery', 'ref-x': .4, 'ref-y': .2 },
        rect: { fill: '#2ECC71' },
        '.inPorts circle': { fill: '#16A085', magnet: 'passive', type: 'input' },
        '.outPorts circle': { fill: '#E74C3C', type: 'output' }
    }
    });
var component = {};

    component.up = new joint.shapes.devs.Model({
     id:'up/'+ generateUUID(),//groupID+UUID
    position: { x: 50, y: 50 },
    size: { width: 90, height: 90 },
    inPorts: [],
    outPorts: ['out'],
    attrs: {
        '.label': { text: 'up', 'ref-x': .4, 'ref-y': .2 },
        rect: { fill: '#2ECC71' },
        '.inPorts circle': { fill: '#16A085', magnet: 'passive', type: 'input' },
        '.outPorts circle': { fill: '#E74C3C', type: 'output' }
    }
    });

        component.down = new joint.shapes.devs.Model({
               id:'down/'+ generateUUID(),//groupID+UUID
    position: { x: 50, y: 200 },
    size: { width: 90, height: 90 },
    inPorts: [],
    outPorts: ['out'],
    attrs: {
        '.label': { text: 'down', 'ref-x': .4, 'ref-y': .2 },
        rect: { fill: '#2ECC71' },
        '.inPorts circle': { fill: '#16A085', magnet: 'passive', type: 'input' },
        '.outPorts circle': { fill: '#E74C3C', type: 'output' }
    }
    });

        component.multi = new joint.shapes.devs.Model({
     id:'multi/'+ generateUUID(),//groupID+UUID
    position: { x: 300, y: 50 },
    size: { width: 90, height: 90 },
    inPorts: ['in'],
    outPorts: ['out'],
    attrs: {
        '.label': { text: 'multi', 'ref-x': .4, 'ref-y': .2 },
        rect: { fill: '#2ECC71' },
        '.inPorts circle': { fill: '#16A085', magnet: 'passive', type: 'input' },
        '.outPorts circle': { fill: '#E74C3C', type: 'output' }
    }
    });

    component.display= new joint.shapes.devs.Model({
           id:'display/'+ generateUUID(),//groupID+UUID
      comid:"display",
    position: { x: 600, y: 150 },
    size: { width: 90, height: 90 },
    inPorts: ['in'],
    outPorts: [],
    attrs: {
        '.label': { text: 'display', 'ref-x': .4, 'ref-y': .2 },
        rect: { fill: '#2ECC71' },
        '.inPorts circle': { fill: '#16A085', magnet: 'passive', type: 'input' },
        '.outPorts circle': { fill: '#E74C3C', type: 'output' }
    }
});

 graph.addCells([component.up,component.down,component.display,component.multi]);

//コンポーネントスクリプト
var compcode =[];

compcode.up = function(num){
  console.log("through up");
  return 1;
}

compcode.down = function(num){
  console.log("through down");
  return -1;
}

compcode.multi = function(num){
  console.log("through multi");
  return num*2;
}

compcode.display = function(num){
  console.log("through display");
  console.log($("#counter").text());
  var sum = Number($("#counter").text()) + num;
 $('#counter').text(sum);
 return 0;
}




var linkInOpt = [];
var linkOutOpt = [];
linkInOpt.inbound = true;
linkOutOpt.outbound = true;

  var allInConnectedElementList = [];
//Create Componentボタンが押されたときの挙動
$('#create-component').click(function(){

});
//deployボタンが押されたときの挙動
$('#deploy').click(function(){


//inが接続されていないoutのlinkの削除
var allElement = graph.getElements();
  var delLinkFin;
do{
  delLinkFin = true;
allElement.forEach(function(element){
  if(typeof element.ports.in !== "undefined" && graph.getConnectedLinks(element,linkInOpt).length == 0 && graph.getConnectedLinks(element,linkOutOpt).length != 0){
    graph.removeLinks(element);
    console.log("removed links!!");
    delLinkFin = false;
  }
});
}while(!delLinkFin)

//outが接続されていないinのlinkの削除
do{
  delLinkFin = true;
allElement.forEach(function(element){
  if(typeof element.ports.out !== "undefined" && graph.getConnectedLinks(element,linkInOpt).length != 0 && graph.getConnectedLinks(element,linkOutOpt).length == 0){
    graph.removeLinks(element);
    console.log("removed links!!");
    delLinkFin = false;
  }
});
}while(!delLinkFin)


  var unconnectedElementQueue = new Queue();
  var uncheckedElementList = graph.getElements();

    //flowのdispose()
   Object.keys(allInConnectedElementList).forEach(function (elementID) {
   	if(typeof allInConnectedElementList[elementID] === 'function'){
   		allInConnectedElementList[elementID]();
   		console.log("delete: " + elementID);
   	}
   });
   allInConnectedElementList = [];

   //ソースをallInConnectedElementListに入れる
  uncheckedElementList.forEach(function(element) {
    //源流のとき
if (typeof element.ports.in === "undefined" && graph.getConnectedLinks(element).length != 0) {
    
    allInConnectedElementList[element.id] = createSourceFlow().map(compcode[getGroupID(element.id)]);
      //それ以外
}else{
  unconnectedElementQueue.enqueue(element);
}

  
});
var element;
while( element = unconnectedElementQueue.dequeue()){
  var links = graph.getConnectedLinks(element,linkInOpt);
  //inで接続されている数がひとつの場合
  if(links.length == 1){
    var connectedElement = false;
  links.forEach(function(link){
    Object.keys(allInConnectedElementList).forEach(function (elementID) {
    if(link.getSourceElement().id == elementID){
      if (typeof element.ports.out === "undefined") {
        allInConnectedElementList[element.id] = allInConnectedElementList[elementID].onValue(compcode[getGroupID(element.id)]);
        connectedElement = true;
        console.log(elementID + "--->" +element.id);
      }else{
        allInConnectedElementList[element.id] = allInConnectedElementList[elementID].map(compcode[getGroupID(element.id)]);
        connectedElement = true;
        console.log(elementID + "--->" +element.id);
      }
    }
    });
  });
  if(!connectedElement){
    unconnectedElementQueue.enqueue(element);
  }

   //inで接続されている数が複数の場合
  }else if(links.length > 1){
    var connectPermission = false;
    var connectCounter = 0;
    links.forEach(function(link){
   Object.keys(allInConnectedElementList).forEach(function (elementID) {
    if(link.getSourceElement().id == elementID){
    connectCounter++;
    }
    });
    if(connectCounter == links.length){
      connectPermission = true;
    }
  });

  //merge可能
  if(connectPermission){
    var mergeFlow = null;
 links.forEach(function(link){
   Object.keys(allInConnectedElementList).forEach(function (elementID) {
    if(link.getSourceElement().id == elementID){
      if(mergeFlow == null){
      mergeFlow = allInConnectedElementList[elementID];
                   console.log("merge: " + elementID)
      }else{
      mergeFlow = mergeFlow.merge(allInConnectedElementList[elementID]);
             console.log("merge: " + elementID)
      }
    }
    });
  });
     if (typeof element.ports.out === "undefined") {
       allInConnectedElementList[element.id] = mergeFlow.onValue(compcode[getGroupID(element.id)]);
           console.log("merged flow" + "--->" +element.id);
     }else{
   allInConnectedElementList[element.id] = mergeFlow.map(compcode[getGroupID(element.id)]);
           console.log("merged flow" + "--->" +element.id);
     }
  }else{
    unconnectedElementQueue.enqueue(element);
  }
  }
}
});

//jquery ui
var startPosition;

  $( function() {
    $( ".draggableComponent").draggable({
            appendTo: "body",
            helper: "clone",
        start: function(){
            var finalOffset = $(this).offset();
            startPosition = finalOffset;
            var finalxPos = finalOffset.left;
            var finalyPos = finalOffset.top;

            console.log('Final X: ' + finalxPos);
            console.log('Final Y: ' + finalyPos);
        }
});

    $( "#droppable" ).resizable({
      stop:function(event,ui){
        var width = ui.size.width;
        var height = ui.size.height;
        paper.setDimensions(width,height);
        console.log("width:" + width);
      }
    }).droppable({
      accept: ".draggableComponent",
      classes: {
        "ui-droppable-active": "ui-state-active",
        "ui-droppable-hover": "ui-state-hover"
      },
      drop: function( event, ui ) {
 var componentID  = ui.draggable.attr("id");
var addComponent = component[componentID].clone();
addComponent.position(ui.position.left-$("#droppable").offset().left,ui.position.top -$("#droppable").offset().top );
addComponent.set('id', componentID + "/" + generateUUID());
graph.addCell(addComponent);
      }
    });
  } );

 $( function() {
    $( ".accordion" ).accordion({
      heightStyle: "fill"
    });
     $( "#sortable" ).sortable({
      revert: true
    });
    $( "#accordion-resizer" ).resizable({
      minHeight: 140,
      minWidth: 200,
      resize: function() {
        $( ".accordion" ).accordion( "refresh" );
      }
    });
  } );

//tooltipの生成
 Object.keys(component).forEach(function (key) {
    $('#'+key).tooltip({
        position: {
      my: 'left center',
      at: 'right+10 center'
    },
      show: {
        effect: "slideDown",
        delay: 250
      }
    });
 });

  $( function() {
    $( "#tabs" ).tabs();
  } );


//option radio button
  $( function() {
    $( "input[type='radio']" ).checkboxradio();
    $( "fieldset" ).controlgroup();
  } );

  //toggleの関数定義とバインドハンドラ
     function handleName(e) {
       console.log("component name is changed");
       stationeryComponent.attr('.label/text',$("#component-name").val());
              console.log($("#component-name").val());
              stationeryComponent.set('id', $("#component-name").val() + "/" + generateUUID());
       console.log(stationeryComponent);
     }

     function handleInOutType(e){
       console.log("inout type is changed");
       console.log(e.currentTarget.id);

       var changeInOut = [];
       changeInOut["in-out"] = function(){
          stationeryComponent.set(`inPorts`,['IN']);
          stationeryComponent.set(`outPorts`,['OUT']);
       }
      changeInOut["only-in"] = function(){
          stationeryComponent.set(`inPorts`,['IN']);
          stationeryComponent.set(`outPorts`,[]);
       }
      changeInOut["only-out"] = function(){
          stationeryComponent.set(`inPorts`,[]);
          stationeryComponent.set(`outPorts`,['OUT']);
       }

       changeInOut[e.currentTarget.id]();
       console.log(stationeryComponent);

     }

 $( "#component-name").on( "change", handleName );
  $( "[name='inout-type']").on( "change", handleInOutType );
//Ace Editor
   var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/javascript");
    editor.insert("Something cool");
    editor.gotoLine(1);
    editor.resize()
</script>

</body>

</html>